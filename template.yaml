AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: >-
  Tarako API Resource template

Globals:
  Function:
    Timeout: 3
    Runtime: python3.9

Resources:

  ApiGateway:
    Type: 'AWS::Serverless::Api'
    Properties:
      Name: !Sub tarako-api-test
      StageName: dev
      DefinitionUri:
        Bucket: !Sub ${S3Bucket}
        Key: !Sub ${S3Dir}/${OpenApiFile}
 
  GetSectionsFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/sections/
      Handler: get_list.lambda_handler
      FunctionName: !Sub get-sections-${PrNumber}
      Events:
        UsersGetEvent:
          Type: Api
          Properties:
            Path: /sections
            Method: get

  GetSectionEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/sections/
      Handler: get_entry.lambda_handler
      FunctionName: !Sub get-section-entry-${PrNumber}
      Events:
        UsersGetUserEvent:
          Type: Api
          Properties:
            Path: /sections/{section_id}
            Method: get

  GetUsersFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/users/
      Handler: get_list.lambda_handler
      FunctionName: !Sub get-users-${PrNumber}
      Events:
        UsersGetEvent:
          Type: Api
          Properties:
            Path: /users
            Method: get

  GetUserEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/users/
      Handler: get_user.lambda_handler
      FunctionName: !Sub get-user-entry-${PrNumber}
      Events:
        UsersGetUserEvent:
          Type: Api
          Properties:
            Path: /users/{user_id}
            Method: get

  TasksGetFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/tasks/
      Handler: get_list.lambda_handler
      FunctionName: !Sub get-tasks-${PrNumber}
      Events:
        TasksGetEvent:
          Type: Api
          Properties:
            Path: /tasks
            Method: get

  PostTaskFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/tasks/
      Handler: post.lambda_handler
      FunctionName: !Sub post-task-${PrNumber}
      Events:
        TasksPostEvent:
          Type: Api
          Properties:
            Path: /tasks
            Method: post

  GetTaskEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/tasks/
      Handler: get_task.lambda_handler
      FunctionName: !Sub get-task-entry-${PrNumber}
      Events:
        TasksGetTaskEvent:
          Type: Api
          Properties:
            Path: /tasks/{task_id}
            Method: get

  PutTaskEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/tasks/
      Handler: put.lambda_handler
      FunctionName: !Sub put-task-entry-${PrNumber}
      Events:
        TasksPutTaskEvent:
          Type: Api
          Properties:
            Path: /tasks/{task_id}
            Method: put

  DeleteTaskEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/tasks/
      Handler: delete.lambda_handler
      FunctionName: !Sub delete-task-entry-${PrNumber}
      Events:
        TasksDeleteTaskEvent:
          Type: Api
          Properties:
            Path: /tasks/{task_id}
            Method: delete

  GetAllUsersDiariesFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/users/
      Handler: get_all_users_list.lambda_handler
      FunctionName: !Sub get-all-users-diaries-${PrNumber}
      Events:
        DiaryUsersGetEvent:
          Type: Api
          Properties:
            Path: /diary/users
            Method: get

  GetUserDiariesFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/users/
      Handler: get_single_user_list.lambda_handler
      FunctionName: !Sub get-user-diaries-${PrNumber}
      Events:
        DiaryUsersGetUserEvent:
          Type: Api
          Properties:
            Path: /diary/users/{user_id}
            Method: get

  PostUserDiaryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/users/
      Handler: post_entry.lambda_handler
      FunctionName: !Sub post-user-diary-${PrNumber}
      Events:
        DiaryUsersPostUserEvent:
          Type: Api
          Properties:
            Path: /diary/users/{user_id}
            Method: post

  GetUserDiaryEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/users/
      Handler: get_entry.lambda_handler
      FunctionName: !Sub get-user-diary-entry-${PrNumber}
      Events:
        DiaryUsersGetUserDiaryEvent:
          Type: Api
          Properties:
            Path: /diary/users/{user_id}/{diary_id}
            Method: get

  PutUserDiaryEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/users/
      Handler: put_entry.lambda_handler
      FunctionName: !Sub put_user-diary-entry-${PrNumber}
      Events:
        DiaryUsersPutUserDiaryEvent:
          Type: Api
          Properties:
            Path: /diary/users/{user_id}/{diary_id}
            Method: put

  DeleteUserDiaryEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/users/
      Handler: delete_entry.lambda_handler
      FunctionName: !Sub delete-user-diary-entry-${PrNumber}
      Events:
        DiaryUsersDeleteUserDiaryEvent:
          Type: Api
          Properties:
            Path: /diary/users/{user_id}/{diary_id}
            Method: delete

  GetAllSectionsDiariesFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/sections/
      Handler: get_all_sections_list.lambda_handler
      FunctionName: !Sub get-all-sections-diaries-${PrNumber}
      Events:
        DiarySectionsGetEvent:
          Type: Api
          Properties:
            Path: /diary/sections
            Method: get

  GetSectionDiariesFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/sections/
      Handler: get_single_section_list.lambda_handler
      FunctionName: !Sub get-section-diaries-${PrNumber}
      Events:
        DiarySectionsGetSectionEvent:
          Type: Api
          Properties:
            Path: /diary/sections/{section_id}
            Method: get

  PostSectionDiaryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/sections/
      Handler: post_entry.lambda_handler
      FunctionName: !Sub post-section-diary-${PrNumber}
      Events:
        DiarySectionsPostSectionEvent:
          Type: Api
          Properties:
            Path: /diary/sections/{section_id}
            Method: post

  GetSectionDiaryEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/sections/
      Handler: get_entry.lambda_handler
      FunctionName: !Sub get-section-diary-entry-${PrNumber}
      Events:
        DiarySectionsGetSectionDiaryEvent:
          Type: Api
          Properties:
            Path: /diary/sections/{section_id}/{diary_id}
            Method: get

  PutSectionDiaryEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/sections/
      Handler: put_entry.lambda_handler
      FunctionName: !Sub put-section-diary-entry-${PrNumber}
      Events:
        DiarySectionsPutSectionDiaryEvent:
          Type: Api
          Properties:
            Path: /diary/sections/{section_id}/{diary_id}
            Method: put

  DeleteSectionDiaryEntryFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      CodeUri: app/diary/sections/
      Handler: delete_entry.lambda_handler
      FunctionName: !Sub delete-section-diary-entry-${PrNumber}
      Events:
        DiarySectionsDeleteSectionDiaryEvent:
          Type: Api
          Properties:
            Path: /diary/sections/{section_id}/{diary_id}
            Method: delete
 
  TarakoTasksTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: !Sub TasksTable-${PrNumber}
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 30
        WriteCapacityUnits: 30

  TarakoUserDiaryTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: !Sub UserDiaryTable-${PrNumber}
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 30
        WriteCapacityUnits: 30

  TarakoSectionDiaryTable:
    Type: 'AWS::DynamoDB::Table'
    Properties:
      TableName: !Sub SectionDiaryTable-${PrNumber}
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 30
        WriteCapacityUnits: 30
